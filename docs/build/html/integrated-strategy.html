

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Integrated trading strategy &mdash; algotrading 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Introduction to Paper Trading" href="introduction-to-paper-trading.html" />
    <link rel="prev" title="Sentiment analysis" href="sentiment-analysis.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> algotrading
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="how-to-use-this.html">How to use this</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Part 1: Intro to Algo Trading</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-science-basics.html">Data science basics</a></li>
</ul>
<p class="caption"><span class="caption-text">Part 2: Core trading strategies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="technical-analysis.html">Technical analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="fundamental-analysis.html">Fundamental analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation-metrics.html">Evaluation metrics</a></li>
</ul>
<p class="caption"><span class="caption-text">Bonus: Julia for algo trading</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction-to-julia.html">Introduction to Julia</a></li>
<li class="toctree-l1"><a class="reference internal" href="julia-data-science-basics.html">Data science basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="julia-technical-analysis.html">Write a technical strategy</a></li>
</ul>
<p class="caption"><span class="caption-text">Part 3: Machine Learning</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bankruptcy-prediction.html">Bankruptcy prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="property-price-prediction.html">Property price prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment-analysis.html">Sentiment analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Integrated trading strategy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#putting-it-all-together">Putting it all together</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simple-approach">Simple approach</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#baseline-model">Baseline model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#machine-learning-approach">Machine learning approach</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#recurrent-neural-networks">Recurrent Neural Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#single-feature-lstm-model">Single-feature LSTM model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-feature-lstm-model">Multi-feature LSTM model</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Bonus: Trade execution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction-to-paper-trading.html">Introduction to Paper Trading</a></li>
</ul>
<p class="caption"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="acknowledgement.html">Acknowledgement</a></li>
<li class="toctree-l1"><a class="reference internal" href="about-the-author.html">About the author</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">algotrading</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Integrated trading strategy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/integrated-strategy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="integrated-trading-strategy">
<h1>Integrated trading strategy<a class="headerlink" href="#integrated-trading-strategy" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, you will learn:</p>
<ul class="simple">
<li><p>How to make use of different features to write a strategy</p></li>
<li><p>How to use machine learning models to predict trading signals</p></li>
</ul>
<div class="section" id="putting-it-all-together">
<h2>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">In this part we’ll look into how to put everything together in order to build a strategy that
incorporates different features (technical indicator, macroeconomic trends and sentiment indicator) so as to
comprehensively examine the market as a whole.</div>
</div>
</div>
<div class="section" id="simple-approach">
<h2>Simple approach<a class="headerlink" href="#simple-approach" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">We’ll first look into simplistic, rule-based methods to make use of the features in an
algorithmic trading pipeline.</div>
</div>
<div class="section" id="baseline-model">
<h3>Baseline model<a class="headerlink" href="#baseline-model" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">We have created the <em>Baseline model</em> example to demonstrate how we could generate signals using a technical
analysis strategy, then filter it by macroeconomic data and sentiment labels. The implementation of the
baseline model could be found in <code class="code docutils literal notranslate"><span class="pre">integrated-strategy/baseline.py</span></code>.</div>
</div>
<div class="line-block">
<div class="line">The workflow of the baseline model is as follows:</div>
</div>
<ul class="simple">
<li><p>Generate the signals dataframe using a technical analysis strategy (e.g. MACD)</p></li>
<li><p>Pass the signals to the macroeconomic filter</p></li>
<li><p>Pass the signals to the sentiment filter</p></li>
<li><p>Backtest with the filtered signals dataframe</p></li>
</ul>
<p>As usual, we first select the ticker and time range to run the strategy:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># load price data</span>
<span class="n">df_whole</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../database/microeconomic_data/hkex_ticks_day/hkex_0001.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;0005.HK&quot;</span>

<span class="c1"># select time range (for trading)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-01-01&#39;</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2021-01-01&#39;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df_whole</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Note that we’ll also need this <code class="code docutils literal notranslate"><span class="pre">filered_df</span></code> additionally to calculate the stock price’s
sensitivity to economic indicators.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get filtered df for macro analysis</span>
<span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df_whole</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_date</span><span class="p">]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">In the example, we choose to apply the MACD crossover strategy.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply MACD crossover strategy</span>
<span class="n">macd_cross</span> <span class="o">=</span> <span class="n">macdCrossover</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">macd_fig</span> <span class="o">=</span> <span class="n">macd_cross</span><span class="o">.</span><span class="n">plot_MACD</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># hide figure</span>

<span class="c1"># get signals dataframe</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">macd_cross</span><span class="o">.</span><span class="n">gen_signals</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">signal_fig</span> <span class="o">=</span> <span class="n">macd_cross</span><span class="o">.</span><span class="n">plot_signals</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># hide figure</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">After obtaining the signals dataframe by running the technical analysis strategy, we’ll pass it to
the macroeconomic filters and sentiment filter to eliminate signals that are contradicatory with the
economic indicator or sentiment labels.</div>
</div>
<div class="line-block">
<div class="line">In this code snippet, we first apply the macroeconomic filter:</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get ticker&#39;s sensitivity to macro data</span>
<span class="n">s_gdp</span><span class="p">,</span> <span class="n">s_unemploy</span><span class="p">,</span> <span class="n">s_property</span> <span class="o">=</span> <span class="n">GetSensitivity</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>

<span class="c1"># append signals with macro data</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">GetMacrodata</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>

<span class="c1"># calculate adjusting factor</span>
<span class="n">signals</span><span class="p">[</span><span class="s1">&#39;macro_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_gdp</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;GDP&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">s_unemploy</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;Unemployment rate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">s_property</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;Property price&#39;</span><span class="p">]</span>
<span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;macro_factor&#39;</span><span class="p">]</span>

<span class="c1"># round off signals[&#39;signal&#39;] to the nearest integer</span>
<span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">We then apply the sentiment filter:</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_signals</span> <span class="o">=</span> <span class="n">SentimentFilter</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">With this filtered signals dataframe, we could pass it directly to the backtesting function
in order to evaluate the portfolio performance.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio</span><span class="p">,</span> <span class="n">backtest_fig</span> <span class="o">=</span> <span class="n">Backtest</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">filtered_signals</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># hide figure</span>

<span class="c1"># print stats</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Final total value: {value:.4f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Total return: {value:.4f}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">(((</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span> <span class="c1"># for analysis</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;No. of trade: {value}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">signals</span><span class="o">.</span><span class="n">positions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])))</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">We could also make use of the evaluation metric functions:</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate strategy</span>

<span class="c1"># 1. Portfolio return</span>
<span class="n">returns_fig</span> <span class="o">=</span> <span class="n">PortfolioReturn</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
<span class="n">returns_fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Baseline - Portfolio return&#39;</span><span class="p">)</span>
<span class="c1">#returns_fig.savefig(&#39;./figures/baseline_portfolo-return&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 2. Sharpe ratio</span>
<span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">SharpeRatio</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Sharpe ratio: {ratio:.4f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">sharpe_ratio</span><span class="p">))</span>

<span class="c1"># 3. Maximum drawdown</span>
<span class="n">maxDrawdown_fig</span><span class="p">,</span> <span class="n">max_daily_drawdown</span><span class="p">,</span> <span class="n">daily_drawdown</span> <span class="o">=</span> <span class="n">MaxDrawdown</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">maxDrawdown_fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Baseline - Maximum drawdown&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="c1">#maxDrawdown_fig.savefig(&#39;./figures/baseline_maximum-drawdown&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 4. Compound Annual Growth Rate</span>
<span class="n">cagr</span> <span class="o">=</span> <span class="n">CAGR</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;CAGR: {cagr:.4f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cagr</span> <span class="o">=</span> <span class="n">cagr</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="machine-learning-approach">
<h2>Machine learning approach<a class="headerlink" href="#machine-learning-approach" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Moving on, we’ll look into more advanced methods that pass the data features into a machine learning model
in order to make sequential predictions.</div>
</div>
<div class="section" id="recurrent-neural-networks">
<h3>Recurrent Neural Networks<a class="headerlink" href="#recurrent-neural-networks" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">A <strong>recurrent neural network (RNN)</strong> is a type of artificial neural network designed for sequential data or time series data.
As opposed to traditional feedforward neural networks, they are networks with loops in them which allow information to persist.
It has a lot of applications, ranging from language modelling to speech recognition. You can read more about the it in Andrej
Karpathy’s blog post - <a class="reference external" href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">The Unreasonable Effectiveness of Recurrent Neural Networks</a>.</div>
</div>
<div class="line-block">
<div class="line">However, one problem with RNNs is that they have a hard time in capturing long-term dependencies. When making a prediction at the
current time step, RNNs would weigh more recent historical information to be more important. But sometimes contextual information could
lie in the far past. This is When LSTM comes into play.</div>
</div>
<div class="figure align-center" id="id3">
<img alt="&quot;LSTM model.&quot;" src="_images/LSTM.png" style="width: 500px; height: 190px;" />
<p class="caption"><span class="caption-text"><span class="raw-html"><br/></span>
The internal structure of an LSTM. <a class="footnote-reference brackets" href="#id2" id="id1">1</a></span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<div class="line-block">
<div class="line"><strong>Long Short Term Memory networks (LSTMs)</strong> is an improved version of RNN that is specifically designed to avoid the long-term dependency problem.
Their default behaviour is to remember information for long periods of time.</div>
</div>
<div class="line-block">
<div class="line">If you want to know more about the mechanism and details of LSTMs, you could read this great blog post -
<a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/#:~:text=Long%20Short%20Term%20Memory%20networks,many%20people%20in%20following%20work.">Understanding LSTM Networks</a>.</div>
</div>
</div>
<div class="section" id="single-feature-lstm-model">
<h3>Single-feature LSTM model<a class="headerlink" href="#single-feature-lstm-model" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">The implememtation of the single-feature LSTM model could be found in <code class="code docutils literal notranslate"><span class="pre">integrated-strategy/LSTM-train_price-only.py</span></code>.</div>
</div>
<div class="line-block">
<div class="line">We’ll make use of the PyTorch library to build the LSTM model. You could
install the library from here: <a class="reference external" href="https://pytorch.org/">https://pytorch.org/</a>.</div>
</div>
<div class="line-block">
<div class="line">We first load the data for training and testing respectively.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;../../database/microeconomic_data/hkex_ticks_day/&quot;</span>

<span class="c1"># select date range</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2010-01-02&#39;</span><span class="p">,</span><span class="s1">&#39;2016-12-31&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="n">test_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2017-01-03&#39;</span><span class="p">,</span><span class="s1">&#39;2020-09-30&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>

<span class="c1"># select ticker</span>
<span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;0001&quot;</span>

<span class="c1"># load data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">test_dates</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">The <code class="code docutils literal notranslate"><span class="pre">MinMaxScaler</span></code> function from the <code class="code docutils literal notranslate"><span class="pre">sklearn.preprocessing</span></code> is used to
normalise the input features, i.e. they will be transformed into the range [-1,1] in the
following code snippet.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">look_back</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># choose sequence length</span>
</pre></div>
</div>
<p>We can check the shapes of the train and test data:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;x_train.shape = &#39;</span><span class="p">,</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;y_train.shape = &#39;</span><span class="p">,</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;x_test.shape = &#39;</span><span class="p">,</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;y_test.shape = &#39;</span><span class="p">,</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>And then make the traing and testing sets in torch:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># make training and test sets in torch</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</pre></div>
</div>
<p>Moving on, let’s set the hyperparameters.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hyperparameters</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="n">look_back</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">input_dim</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">num_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">output_dim</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># set seed</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">We’ll use mean squared error (MSE) as the loss function, and use Adam as the optimiser with a learning rate
of 0.01.</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>



<span class="n">model</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">output_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">)</span>

<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimiser</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll write the training loop now:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise a list to store the losses</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">)</span>

<span class="c1"># Number of steps to unroll</span>
<span class="n">seq_dim</span> <span class="o">=</span> <span class="n">look_back</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Train model</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="c1"># Forward pass</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_train_pred</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Epoch &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;MSE: &quot;</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="n">hist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># Zero out gradient, else they will accumulate between epochs</span>
    <span class="n">optimiser</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="c1"># Backward pass</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># Update parameters</span>
    <span class="n">optimiser</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">We could now make predictions on the test set to get the MSE:</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make predictions</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

<span class="c1"># Invert predictions</span>
<span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_train_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_test_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

<span class="c1"># Calculate root mean squared error</span>
<span class="n">trainScore</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_train_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Train Score: </span><span class="si">%.2f</span><span class="s1"> RMSE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trainScore</span><span class="p">))</span>
<span class="n">testScore</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_test_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test Score: </span><span class="si">%.2f</span><span class="s1"> RMSE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testScore</span><span class="p">))</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Eventually, we’ll carry out inferencing  and save the output signals dataframe for backtesting:</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inferencing</span>
<span class="n">y_inf_pred</span><span class="p">,</span> <span class="n">y_inf</span> <span class="o">=</span> <span class="n">predict_price</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">gen_signal</span><span class="p">(</span><span class="n">y_inf_pred</span><span class="p">,</span> <span class="n">y_inf</span><span class="p">)</span>

<span class="c1"># Save signals as csv file</span>
<span class="n">output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">output_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span>
<span class="n">output_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Date&quot;</span>

<span class="n">output_filename</span> <span class="o">=</span> <span class="s1">&#39;output/&#39;</span> <span class="o">+</span> <span class="n">symbol</span> <span class="o">+</span> <span class="s1">&#39;_output.csv&#39;</span>
<span class="n">output_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">(Talk about backtesting)</div>
</div>
</div>
<div class="section" id="multi-feature-lstm-model">
<h3>Multi-feature LSTM model<a class="headerlink" href="#multi-feature-lstm-model" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">The implememtation of the single-feature LSTM model could be found in <code class="code docutils literal notranslate"><span class="pre">integrated-strategy/LSTM-train_wrapper.py</span></code>.</div>
</div>
<div class="line-block">
<div class="line">WIP</div>
</div>
<p><strong>References</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.bioinf.jku.at/publications/older/2604.pdf">Long Short Term Memory</a></p></li>
</ul>
<p><strong>Image sources</strong></p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>By Christopher Olah - Understanding LSTM Networks, <a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs">https://colah.github.io/posts/2015-08-Understanding-LSTMs</a></p>
</dd>
</dl>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<div class="line-block">
<div class="line">All investments entail inherent risk. This repository seeks to solely educate
people on methodologies to build and evaluate algorithmic trading strategies.
All final investment decisions are yours and as a result you could make or lose money.</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="introduction-to-paper-trading.html" class="btn btn-neutral float-right" title="Introduction to Paper Trading" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sentiment-analysis.html" class="btn btn-neutral float-left" title="Sentiment analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Angel Woo

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>